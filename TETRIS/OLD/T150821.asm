.286

;Nome: Guilherme Krüger Araujo
;Matricula: 150821

PILHA SEGMENT STACK				
	DW 512 DUP(0)					
PILHA ENDS

DADOS SEGMENT

A	DB 0		;AUXILIAR
X	DB 19		;COLUNA
Y	DB 2		;LINHA
Z	DB ?		;AUX
W	DB ?		;AUX
NP	DB 7		;NUMERO DA PEÇA
P	DB 7		;NUMERO DA NOVA PEÇA
P1	DB ?		;AUX
CR	DB 0		;CONTROLE DE ROTAÇÃO
N	DB 0
PTOS	DB 0		

ESPACO	DB 80 DUP(32)
QUAD	DB ' '
EPTO	DB 'PONTOS '
EPECA	DB 'PROXIMO'
VEL	DB 18
TVEL	DB ?														             ;				
																  				
RANDOM DB 7,1,5,2,1,3,4,6,3,4,5,7,1,5,2,1,3,4,6,3,4,5,7,1,5,2,1,3,4,6,3,4,5,7,1,5,2,1,3,4,6,3,4,5,7,1,5,2,1,3,4,6,3,4,5,7,1,5,2,1,3,4,6,3,4,5,7,1,5,2,1,3,4,6,3,4,7,1,5,2,1,3,4,6,3,4,7,1,5,2,1,3,4,6,3,4
; - = - = - TABELAS DOS OBJETOS - = - = -

TABJ 	DB 0,0,-1,0,0,-1,0,-2

TABL 	DB 0,0,1,0,0,-1,0,-2

TABO 	DB 0,0,1,0,0,-1,1,-1

TABI 	DB 0,0,0,-1,0,-2,0,-3

TABS 	DB 0,0,1,0,1,-1,1,-2

TABZ 	DB 2,0,1,0,0,-1,1,-1

TABT 	DB 0,0,1,0,2,0,1,-1



;MATRIZ DE COLISÃO
;NÃO UTILIZADO
linha1    DB 1,0,0,0,0,0,0,0,0,0,0,1
linha2    DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha3    DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha4    DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha5    DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha6    DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha7    DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha8    DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha9    DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha10   DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha11   DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha12   DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha13   DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha14   DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha15   DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha16   DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha17   DB 1,0,0,0,0,0,0,0,0,0,0,1
linha18   DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha19   DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha20   DB 1,0,0,0,0,0,0,0,0,0,0,1  
linha21   DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha22   DB 1,0,0,0,0,0,0,0,0,0,0,1 
linha23   DB 1,1,1,1,1,1,1,1,1,1,1,1


DADOS ENDS

CODE 	SEGMENT
	ASSUME CS:CODE, DS:DADOS, ES:DADOS, SS:PILHA

START:	MOV AX,DADOS
	MOV DS,AX
	MOV ES,AX
	MOV AX,PILHA
	MOV SS,AX
	MOV SP,1024

	;ESCONDE O CURSOR
      	MOV AH, 01H
	MOV CH, 100000b	
  	INT 10h
      	

	CALL CLS

	CALL DCAMPO
	

	;CORES COM 0 NO PRIMEIRO NUMERO E F NO ULTIMO
	;1:AZUL ESCURO 2:VERDE ESCURO 3: AZUL/VERDE 4:MARROM 5: ROXO 6: COCO 7:CINZA CLARO 8: CINZA 9: AZUL
	;A:VERDE B:CIANO C:VERMELHO D:ROSA E:AMARELO F:BRANCO 

	CALL PECA
		

NOVP:	MOV Y,9		;ARRUMA COORDENADAS
	MOV X,40
	MOV AL,P	;COLOCA O PROXIMA PEÇA EM NP
	MOV NP,AL
	CALL CORES
	MOV BL,0FFH
	CALL DES	;APAGA A PROXIMA PEÇA NO CANTO DA DESCRIÇAO POIS AGORA ELA É A PEÇA ATUAL
	MOV AL,NP	;COLOCA A PEÇA ATUAL NO P1 AUX
	MOV P1,AL	
	
	CALL PECA	;CALCULA A NOVA PROXIMA PEÇA PEÇA
	MOV AL,NP
	MOV P,AL
	CALL PECA
	CALL CORES
	CALL DES	;DESENHA A PROXIMA PECA NO LUGAR DA DESCR

	MOV AL,P1	;COLOCA A PEÇA ATUAL EM NP
	MOV NP,AL

	MOV Y,2		;ARRUMA AS COORDENADAS
	MOV X,19

CAI:    CALL CORES
	CALL DES
	CALL TEMPO

	CMP Y,20
	JE PROX1

	CALL CORES
	MOV BL,0FFH
	CALL DES
	INC Y
	
NEXTKEY:
	MOV AH,1
	INT 16H
	JZ ACTUALLYNOKEY
	MOV AH,0
	INT 16H
	
TSTA:	CMP AL,'A'
	JNE TSTC
	cmp X,10
	je nokey
	
	
	CALL CORES
	MOV BL,0FFH
	CALL DES
	DEC X

	CALL CORES
	CALL DES	

	JMP NOKEY

PROX1:  JMP PROX

TSTC:	CMP AL,'C'
	JNE TSTS	
	
	CALL CORES
	MOV BL,0FFH
	CALL DES
		
	CMP A,0
	JNE PT
	MOV A,1
	JMP PD

PT:	MOV A,0

PD:	CALL CORES
	CALL DES	

	JMP NOKEY


TSTS:
	CMP AL,'S'
	JNE TSTX
	cmp x,29
	JE NOKEY
	
	CALL CORES
	MOV BL,0FFH
	CALL DES	

	INC X

	CALL CORES
	CALL DES
	
	JMP NOKEY

TSTX:	
	CMP AL,' '
	JNE NOKEY
	
	CALL FALL
	JMP PROX

NOKEY:	
	JMP NEXTKEY

ACTUALLYNOKEY:

	JMP CAI
		

PROX:	ADD PTOS,10
	CALL ESCPT
	INC N
	CMP N,15
	JE FIM
	SUB VEL,3
	CMP VEL,3
	JNE VNORM
	MOV VEL,6
VNORM:	MOV A,0
	JMP NOVP





FIM:	MOV AH,4CH	;INTERRUPÇÃO DE RETORNO AO DOS
 	INT 21H


; - = - = - = - PROCEDIMENTOS - = - = - = -

ESCPT PROC

	LEA BP,PTOS		;mensagem de pontuação		
	MOV BH,0
	MOV BL,0F4H
	MOV DL,49
	MOV DH,12
	MOV CX,10
	MOV AH,13H
	MOV AL,1
	INT 10H
	
ESCPT ENDP

FALL PROC
	CALL CORES
	MOV BL,0FFH
	CALL DES

	MOV Y,20
	
	CALL CORES
	CALL DES
	
	RET
FALL ENDP


DES PROC

	CMP A,0
	JNE DET
	CALL DESENHA
	JMP DEF
DET:	CALL DESENHAT
DEF:	RET

DES ENDP


;|=| LIMPA TELA |=|

CLS 	PROC

	MOV CX,25	;25 LINHAS EU QUERO APAGAR
CLS1:
	LEA BP,ESPACO
	MOV BH,0	
	MOV BL,0f0H	;ATRIBUTO DE CORES
	PUSH CX
	MOV DL,0	;COLUMN NUMBER
	MOV DH,CL	;ROW NUMBER
	DEC DH
	MOV CX,80	; COMPRIMENTO DA LINHA
	MOV AH,13H	
	MOV AL,1	;MODO DE IMPRIMIR CARACTERES E NAO ATRIBUTOS
	INT 10H
	POP CX
	LOOP CLS1
	RET

CLS 	ENDP 


;-----DESENHA O CAMPO (CAIXA) DO JOGO-----

DCAMPO	PROC
	MOV CX,21	;21 LINHAS
DCAMPO1:
	LEA BP,QUAD
	MOV BH,0
	MOV BL,0
	PUSH CX
	MOV DL,9	;COLUNA
	ADD CL,1
	MOV DH,CL	;LINHA
	DEC DH
	MOV CX,1	;COMPRIMENTO DA LINHA
	MOV AH,13H
	MOV AL,1
	INT 10H
	POP CX
	LOOP DCAMPO1

	MOV CX,21
DCAMPO2:
	LEA BP,QUAD
	MOV BH,0
	MOV BL,0
	PUSH CX
	MOV DL,30	;COLUNA
	ADD CL,1
	MOV DH,CL	;LINHA
	DEC DH
	MOV CX,1	;COMPRIMENTO DA LINHA
	MOV AH,13H
	MOV AL,1
	INT 10H
	POP CX
	LOOP DCAMPO2

	LEA BP,ESPACO
	MOV BH,0
	MOV BL,0
	MOV DL,9
	MOV DH,21
	MOV CX,22
	MOV AH,13H
	MOV AL,1
	INT 10H

	LEA BP,EPECA		;mensagem da proxima peça
	MOV BH,0
	MOV BL,0F3H
	MOV DL,40
	MOV DH,4
	MOV CX,7
	MOV AH,13H
	MOV AL,1
	INT 10H

	LEA BP,EPTO		;mensagem de pontuação		
	MOV BH,0
	MOV BL,0F4H
	MOV DL,40
	MOV DH,12
	MOV CX,7
	MOV AH,13H
	MOV AL,1
	INT 10H


	RET		

DCAMPO	ENDP	



DESENHA PROC
	PUSH BX
	PUSH DX
	PUSH AX
	PUSH CX
	
	MOV CX,4
UMQUAD:
	;SET CURSOR POSITION
	MOV BH,0
	MOV DH,Y	;dh (linha) recebe y
	ADD DH,DS:[BP+1]		
	MOV DL,X	;dl (coluna) recebe x
	ADD DL,DS:[BP]
	ADD BP,2
	
	MOV AH,2h	
	INT 10H
	
	;DESENHA
	MOV BH,0
	MOV AL,' '
	PUSH CX
	MOV CX,1	;TAMANHO DA STRING
	PUSH AX
	MOV AH,9h	
	INT 10H
	POP AX
	POP CX
	
DES1:	DEC CX
	CMP CX,0
	JNE UMQUAD

	POP CX
	POP AX
	POP DX
	POP BX
	RET


DESENHA ENDP

DESENHAT PROC
	PUSH BX
	PUSH DX
	PUSH AX
	PUSH CX
	
	MOV CX,4
UMQUAD2:
	;SET CURSOR POSITION
	MOV BH,0
	MOV DH,Y	;dh (linha) recebe y
	ADD DH,DS:[BP]		
	MOV DL,X	;dl (coluna) recebe x
	ADD DL,DS:[BP+1]
	ADD BP,2
	
	MOV AH,2h	
	INT 10H
	
	;DESENHA
	MOV BH,0
	MOV AL,' '
	PUSH CX
	MOV CX,1	;TAMANHO DA STRING
	PUSH AX
	MOV AH,9h	
	INT 10H
	POP AX
	POP CX
	
DES2:	DEC CX
	CMP CX,0
	JNE UMQUAD2

	POP CX
	POP AX
	POP DX
	POP BX
	RET


DESENHAT ENDP


;===== TEMPO ====
TEMPO 	PROC
	
	PUSHA
	MOV AH,VEL
	MOV TVEL,AH
TEMP0:	MOV AH,2CH
    	INT 21H
	MOV BH,DL
TEMP1:	MOV AH,2CH
    	INT 21H
	CMP DL,BH
	JE TEMP1
	DEC TVEL
	LOOPNZ TEMP0
	POPA
	
	RET	

TEMPO ENDP

;FUNCAO Q RETORNA UM NUMERO DE 1 A 7 EM CL, USANDO UMA MATRIZ DE NUMEROS E O RELOGIO

RANDOMI PROC

      	PUSH DX
      	PUSH CX
    
    	MOV AH,02H            
    	INT 1AH           

    	POP CX
     
      	MOV DL,DH
      	MOV DH,0           	;zera DH, e DL vai conter os segundos OBTIDOS PELA INTERRUPÇÃO 21H
            
      	LEA BP,random
      	ADD BP,DX
   
      	MOV CL,DS:[BP]
	POP DX

	RET

RANDOMI ENDP

;------------>GERA UM NUMERO RANDOMICO DE 1 A 7 E ARMAZENA NA VARIAVEL NP
PECA PROC
	
	CALL RANDOMI
	MOV NP,CL
	RET

PECA ENDP


;----------->CARREGA A DESCRIÇÃO DA PEÇA NOS REGISTRADORES NECESSARIOS
CORES PROC

	CMP NP,1
	JNE TN2
	MOV BL,0BFH	
	LEA BP,TABI
	JMP RETO

TN2:	CMP NP,2
	JNE TN3
	MOV BL,04FH
	LEA BP,TABJ
	JMP RETO

TN3:	CMP NP,3
	JNE TN4
	MOV BL,09FH
	LEA BP,TABL
	JMP RETO

TN4:	CMP NP,4
	JNE TN5
	MOV BL,0EFH
	LEA BP,TABO
	JMP RETO

TN5:	CMP NP,5
	JNE TN6
	MOV BL,0AFH
	LEA BP,TABS
	JMP RETO

TN6:	CMP NP,6
	JNE TN7
	MOV BL,05FH	
	LEA BP,TABT
	JMP RETO

TN7:	CMP NP,7
	MOV BL,0CFH
	LEA BP,TABZ	

RETO: 	RET

CORES ENDP


CODE 	ENDS

END START







